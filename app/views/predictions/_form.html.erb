<%= simple_form_for @prediction, :html=> { class: 'form-horizontal' } do |f| %>
<div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <div class="modal-title" id="myModalLabel">PREDICT</div>
    </div>
    <div class="modal-body">
        <div class="alert alert-danger" style="display:none">
            <p>Hold on, your prediction isn't ready yet.  You'll need to</p>
            <ul style="padding-left:30px">
            </ul>
        </div>
        <div class="form-group">
          <%= f.input_field :body, :class => 'form-control body', :placeholder => 'Make a prediction...', :maxlength => '300'  %>
        </div>
        <div class="form-group">
        <%= f.input_field :tag_list, :collection => ['SPORTS','ENTERTAINMENT','PERSONAL','BUSINESS','WEATHER', 'POLITICS', 'STOCKS','FUNNY','OTHER'], :class =>'form-control category', :prompt => 'Select a Category' %>
        </div>
        <label for="prediction_expires_at">Voting Ends On...</label>
        <div class="form-group">
          <input type="text" name="prediction[expires_at]" id="prediction_expires_at" style="display:none;"/>
          <div class="input-group input-group-xs" style="display:inline-block;width:49%;">
            <input type="text" class="datepicker form-control" id="prediction_expires_at_date" />
          </div>
          <div class="bootstrap-timepicker input-group input-group-xs"  style="display:inline-block;width:49%">
            <input id="prediction_expires_at_time" type="text" class="form-control"><i class="icon-time"></i>
          </div>
        </div>
        <label for="prediction_resolution_date">I'll Knoda Result On...</label>
        <div class="form-group">
          <input type="text" name="prediction[resolution_date]" id="prediction_resolution_date" style="display:none;"/>
          <div class="input-group input-group-xs" style="display:inline-block;width:49%">
            <input type="text" class="datepicker form-control" id="prediction_resolution_date_date" />
          </div>
          <div class="bootstrap-timepicker input-group input-group-xs"  style="display:inline-block;width:49%">
            <input id="prediction_resolution_date_time" type="text" class="form-control"><i class="icon-time"></i>
          </div>
        </div>        
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      <%= f.button :submit , :class => 'btn btn-success' %>
    </div>
  </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
<% end %>            
<script>
  var updateDate = function(target,date, time) {
      m = moment().local(date)
      if (time.meridian == 'AM') {
        m.add('hours', time.hours)
      } else {
        m.add('hours', time.hours+12)
      }
      m.add('minutes', time.minutes)
      target.val(m.toISOString());
  }

  var clearValidation = function() {
    $('#new_prediction .alert ul').empty()
    $('#new_prediction .alert').hide()
  }
  var validateNewPrediction = function() {
    clearValidation()
    var body = $('#new_prediction .body').val().trim()
    var category = $('#new_prediction .category option:selected').val().trim()
    var expires_at = moment($('#prediction_expires_at').val())
    var resolution_date = moment($('#prediction_resolution_date').val())
    console.log(expires_at);
    var errors = []
    if (body == '')
      errors.push({msg: 'Enter a short prediction.'})
    if (category == '')
      errors.push({msg: 'Choose a category.'})
    if (!expires_at.isValid())
      errors.push({ msg: 'Choose a date for voting to end.'})
    if (!resolution_date.isValid())
      errors.push({ msg: 'Choose a date for to resolve your prediction.'})
    if (resolution_date.isBefore(expires_at))
      errors.push({ msg: 'Set a resolution date after the voting ends.'})     
    if (expires_at.isBefore(moment()))
      errors.push({ msg: 'Set a voting end date in the future.'})       
    if (resolution_date.isBefore(moment()))
      errors.push({ msg: 'Set a resolution date in the future.'})              
    if (errors.length == 0) {
      console.log($('#new_prediction').serialize());
      return true
    }else {
      $('#new_prediction .alert').show()
      for (var i in errors) {
        $('#new_prediction .alert ul').append("<li>" + errors[i].msg + "</li>")
      }
      return false
    }
  }

$(function() {
 $('textarea').maxlength({
    alwaysShow: true 
  }); 
  // Form Submission
  $('#new_prediction').on('submit', function(e) {
    e.preventDefault()
    if (validateNewPrediction()) {
      createPrediction()
    } 
  });

  //Set defaults
  $('#prediction_expires_at').val(moment().add('minutes', 1).toISOString())
  $('#prediction_resolution_date').val(moment().add('minutes', 2).toISOString())
  // Expires_at
  $("input#prediction_expires_at_date").datepicker({
    startDate: moment().format("MM/DD/YYYY"),
    todayBtn: true,
    autoclose: true,
    todayHighlight: true    
  }).on('changeDate', function(e) {
    x = moment($('input#prediction_expires_at_time').val(), 'hh:mm A');
    updateDate($('#prediction_expires_at'), $("input#prediction_expires_at_date").datepicker('getDate'), {hours : x.hours(), minutes: x.minutes(), meridian: 'AM'});
  });
  $("input#prediction_expires_at_date").datepicker('update', new Date());
  $('input#prediction_expires_at_time').timepicker({
    template: false,
    showInputs: false,
    minuteStep: 5,
    defaultTime: moment().add('minutes',1).format('hh:mm A')
  }).on('changeTime.timepicker', function(e) {
    updateDate($('#prediction_expires_at'), $("input#prediction_expires_at_date").datepicker('getDate'), e.time);
  });
  // Resolution_date
  $("input#prediction_resolution_date_date").datepicker({
    startDate: moment().format("MM/DD/YYYY"),
    todayBtn: true,
    autoclose: true,
    todayHighlight: true    
  }).on('changeDate', function(e) {
    x = moment($('input#prediction_resolution_date_time').val(), 'hh:mm A');
    updateDate($('#prediction_resolution_date'), $("input#prediction_resolution_date_date").datepicker('getDate'), {hours : x.hours(), minutes: x.minutes(), meridian: 'AM'});
  });
  $("input#prediction_resolution_date_date").datepicker('update', new Date());
  $('input#prediction_resolution_date_time').timepicker({
    template: false,
    showInputs: false,
    minuteStep: 5,
    defaultTime: moment().add('minutes',2).format('hh:mm A')
  }).on('changeTime.timepicker', function(e) {
    updateDate($('#prediction_resolution_date'), $("input#prediction_resolution_date_date").datepicker('getDate'), e.time);
  });  
});
</script>